{% extends "base.html" %}

{% block title %}Theses - Alpaca Trading{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-6">Theses</h1>

<!-- Analytics Summary -->
<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
    <div class="bg-white rounded-lg shadow p-4">
        <div class="text-sm text-gray-500">Active</div>
        <div class="text-2xl font-bold text-blue-600">{{ stats.active }}</div>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
        <div class="text-sm text-gray-500">Executed</div>
        <div class="text-2xl font-bold text-green-600">{{ stats.executed }}</div>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
        <div class="text-sm text-gray-500">Invalidated</div>
        <div class="text-2xl font-bold text-red-600">{{ stats.invalidated }}</div>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
        <div class="text-sm text-gray-500">Expired</div>
        <div class="text-2xl font-bold text-gray-600">{{ stats.expired }}</div>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
        <div class="text-sm text-gray-500">Success Rate</div>
        <div class="text-2xl font-bold">{% if stats.success_rate is not none %}{{ "%.1f"|format(stats.success_rate) }}%{% else %}N/A{% endif %}</div>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
        <div class="text-sm text-gray-500">Confidence (Active)</div>
        <div class="text-sm mt-1">
            {% if stats.confidence_dist %}
                {% if stats.confidence_dist.high %}<span class="text-green-600">H:{{ stats.confidence_dist.high }}</span> {% endif %}
                {% if stats.confidence_dist.medium %}<span class="text-yellow-600">M:{{ stats.confidence_dist.medium }}</span> {% endif %}
                {% if stats.confidence_dist.low %}<span class="text-gray-600">L:{{ stats.confidence_dist.low }}</span>{% endif %}
            {% else %}
                -
            {% endif %}
        </div>
    </div>
</div>

<!-- Filters -->
<div class="bg-white rounded-lg shadow p-4 mb-6">
    <form method="get" class="flex flex-wrap gap-4 items-center">
        <div>
            <label class="text-sm text-gray-500 mr-2">Status:</label>
            <select name="status" onchange="this.form.submit()" class="border rounded px-2 py-1">
                <option value="all" {% if current_filter == 'all' %}selected{% endif %}>All</option>
                <option value="active" {% if current_filter == 'active' %}selected{% endif %}>Active</option>
                <option value="executed" {% if current_filter == 'executed' %}selected{% endif %}>Executed</option>
                <option value="invalidated" {% if current_filter == 'invalidated' %}selected{% endif %}>Invalidated</option>
                <option value="expired" {% if current_filter == 'expired' %}selected{% endif %}>Expired</option>
            </select>
        </div>
        <div>
            <label class="text-sm text-gray-500 mr-2">Sort:</label>
            <select name="sort" onchange="this.form.submit()" class="border rounded px-2 py-1">
                <option value="newest" {% if current_sort == 'newest' %}selected{% endif %}>Newest</option>
                <option value="oldest" {% if current_sort == 'oldest' %}selected{% endif %}>Oldest</option>
                <option value="confidence" {% if current_sort == 'confidence' %}selected{% endif %}>Confidence</option>
                <option value="ticker" {% if current_sort == 'ticker' %}selected{% endif %}>Ticker</option>
            </select>
        </div>
    </form>
</div>

<!-- Thesis Cards -->
{% if theses %}
<div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
    {% for thesis in theses %}
    <div class="bg-white rounded-lg shadow">
        <!-- Header -->
        <div class="p-4 border-b flex items-center justify-between flex-wrap gap-2">
            <div class="flex items-center gap-2">
                <span class="font-bold text-lg">{{ thesis.ticker }}</span>
                <!-- Direction badge -->
                {% if thesis.direction == 'long' %}
                <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">Long</span>
                {% elif thesis.direction == 'short' %}
                <span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded">Short</span>
                {% else %}
                <span class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded">Avoid</span>
                {% endif %}
            </div>
            <div class="flex items-center gap-2">
                <!-- Confidence badge -->
                {% if thesis.confidence == 'high' %}
                <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">High</span>
                {% elif thesis.confidence == 'medium' %}
                <span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded">Medium</span>
                {% else %}
                <span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded">Low</span>
                {% endif %}
                <!-- Status badge -->
                {% if thesis.status == 'active' %}
                <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">Active</span>
                {% elif thesis.status == 'executed' %}
                <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">Executed</span>
                {% elif thesis.status == 'invalidated' %}
                <span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded">Invalidated</span>
                {% else %}
                <span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded">Expired</span>
                {% endif %}
            </div>
        </div>

        <!-- Body -->
        <div class="p-4 space-y-3 text-sm">
            <div>
                <div class="font-medium text-gray-700">Thesis</div>
                <div class="text-gray-600">{{ thesis.thesis }}</div>
            </div>
            {% if thesis.entry_trigger %}
            <div>
                <div class="font-medium text-gray-700">Entry Trigger</div>
                <div class="text-gray-600">{{ thesis.entry_trigger }}</div>
            </div>
            {% endif %}
            {% if thesis.exit_trigger %}
            <div>
                <div class="font-medium text-gray-700">Exit Trigger</div>
                <div class="text-gray-600">{{ thesis.exit_trigger }}</div>
            </div>
            {% endif %}
            {% if thesis.invalidation %}
            <div>
                <div class="font-medium text-gray-700">Invalidation</div>
                <div class="text-gray-600">{{ thesis.invalidation }}</div>
            </div>
            {% endif %}
        </div>

        <!-- Footer -->
        <div class="p-4 border-t bg-gray-50 text-xs text-gray-500 flex justify-between items-center">
            <div>
                Created: {{ thesis.created_at.strftime('%Y-%m-%d') if thesis.created_at else '-' }}
                {% if thesis.updated_at and thesis.updated_at != thesis.created_at %}
                | Updated: {{ thesis.updated_at.strftime('%Y-%m-%d') }}
                {% endif %}
            </div>
            <div class="flex items-center gap-2">
                {% if thesis.status == 'active' %}
                <button onclick="openCloseModal({{ thesis.id }}, '{{ thesis.ticker }}', 'invalidated')"
                        class="bg-red-100 hover:bg-red-200 text-red-800 text-xs px-2 py-1 rounded">
                    Invalidate
                </button>
                <button onclick="openCloseModal({{ thesis.id }}, '{{ thesis.ticker }}', 'expired')"
                        class="bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs px-2 py-1 rounded">
                    Expire
                </button>
                {% endif %}
                <span class="bg-gray-200 px-2 py-0.5 rounded">{{ thesis.source }}</span>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="bg-white rounded-lg shadow p-8 text-center text-gray-500">
    No theses found{% if current_filter != 'all' %} with status "{{ current_filter }}"{% endif %}.
</div>
{% endif %}

<!-- Close Thesis Modal -->
<div id="closeModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md mx-4">
        <h3 id="modalTitle" class="text-lg font-bold mb-4">Close Thesis</h3>
        <p class="text-sm text-gray-600 mb-4">
            Closing thesis for <span id="modalTicker" class="font-bold"></span>
        </p>
        <div class="mb-4">
            <label class="block text-sm text-gray-700 mb-1">Reason (optional)</label>
            <textarea id="closeReason" rows="3" class="w-full border rounded px-3 py-2 text-sm"
                      placeholder="Why is this thesis being closed?"></textarea>
        </div>
        <div class="flex justify-end gap-2">
            <button onclick="closeModal()" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800">
                Cancel
            </button>
            <button id="confirmBtn" onclick="confirmClose()" class="px-4 py-2 text-sm text-white rounded">
                Confirm
            </button>
        </div>
    </div>
</div>

<script>
let currentThesisId = null;
let currentStatus = null;

function openCloseModal(thesisId, ticker, status) {
    currentThesisId = thesisId;
    currentStatus = status;

    document.getElementById('modalTicker').textContent = ticker;
    document.getElementById('closeReason').value = '';

    const title = status === 'invalidated' ? 'Invalidate Thesis' : 'Expire Thesis';
    document.getElementById('modalTitle').textContent = title;

    const btn = document.getElementById('confirmBtn');
    if (status === 'invalidated') {
        btn.className = 'px-4 py-2 text-sm text-white rounded bg-red-600 hover:bg-red-700';
        btn.textContent = 'Invalidate';
    } else {
        btn.className = 'px-4 py-2 text-sm text-white rounded bg-gray-600 hover:bg-gray-700';
        btn.textContent = 'Expire';
    }

    document.getElementById('closeModal').classList.remove('hidden');
    document.getElementById('closeModal').classList.add('flex');
}

function closeModal() {
    document.getElementById('closeModal').classList.add('hidden');
    document.getElementById('closeModal').classList.remove('flex');
    currentThesisId = null;
    currentStatus = null;
}

async function confirmClose() {
    if (!currentThesisId || !currentStatus) return;

    const reason = document.getElementById('closeReason').value.trim();

    try {
        const response = await fetch(`/api/theses/${currentThesisId}/close`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: currentStatus, reason: reason || null })
        });

        const data = await response.json();

        if (response.ok) {
            window.location.reload();
        } else {
            alert(data.error || 'Failed to close thesis');
        }
    } catch (err) {
        alert('Error: ' + err.message);
    }

    closeModal();
}

// Close modal on escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
});

// Close modal on background click
document.getElementById('closeModal').addEventListener('click', (e) => {
    if (e.target.id === 'closeModal') closeModal();
});
</script>
{% endblock %}
